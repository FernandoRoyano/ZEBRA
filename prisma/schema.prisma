// Schema de base de datos para ZEBRA - Facturación

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Sociedad emisora de facturas
model Sociedad {
  id              Int       @id @default(autoincrement())
  nombre          String
  nombreComercial String?
  nif             String    @unique
  direccion       String
  codigoPostal    String
  ciudad          String
  provincia       String
  pais            String    @default("ESP")
  telefono        String?
  email           String?
  iban            String?
  swift           String?
  logoUrl         String?
  ultimoNumero    Int       @default(0)
  serieActual     String    @default("A")
  activa          Boolean   @default(true)
  facturas        Factura[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Cliente receptor de facturas
model Cliente {
  id                 Int       @id @default(autoincrement())
  nombre             String
  nif                String
  direccion          String
  codigoPostal       String
  ciudad             String
  provincia          String
  pais               String    @default("ESP")
  telefono           String?
  email              String?
  // Campos FACe (solo si es administración pública)
  esAdministracion   Boolean   @default(false)
  codigoDir3         String?   // Código DIR3 general
  organoGestor       String?   // Código órgano gestor
  unidadTramitadora  String?   // Código unidad tramitadora
  oficinaContable    String?   // Código oficina contable
  facturas           Factura[]
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

// Factura
model Factura {
  id                Int             @id @default(autoincrement())
  numero            String
  serie             String
  numeroCompleto    String          @unique  // Formato: SERIE-AÑO-NUMERO (ej: "A-2024-0001")
  fechaEmision      DateTime
  fechaVencimiento  DateTime?
  fechaOperacion    DateTime?
  estado            String          @default("BORRADOR") // BORRADOR, EMITIDA, ENVIADA, PAGADA, ANULADA
  baseImponible     Float
  totalIva          Float
  totalFactura      Float
  notas             String?
  formaPago         String          @default("TRANSFERENCIA")
  diasPago          Int             @default(30)
  // Relaciones
  sociedad          Sociedad        @relation(fields: [sociedadId], references: [id])
  sociedadId        Int
  cliente           Cliente         @relation(fields: [clienteId], references: [id])
  clienteId         Int
  lineas            LineaFactura[]
  archivos          ArchivoFactura[]
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

// Línea de factura (concepto)
model LineaFactura {
  id              Int      @id @default(autoincrement())
  factura         Factura  @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  facturaId       Int
  descripcion     String
  cantidad        Float
  precioUnitario  Float
  descuento       Float    @default(0)
  tipoIva         String   @default("IVA")
  porcentajeIva   Float    @default(21)
  subtotal        Float    // cantidad * precioUnitario - descuento
  orden           Int
}

// Archivos generados (PDF, XML)
model ArchivoFactura {
  id          Int      @id @default(autoincrement())
  factura     Factura  @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  facturaId   Int
  tipo        String   // PDF, XML
  rutaArchivo String
  createdAt   DateTime @default(now())
}
